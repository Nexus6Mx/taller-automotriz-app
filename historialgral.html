<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial General de Órdenes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .table-container { max-height: 80vh; overflow-y: auto; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="bg-white shadow-md rounded-lg p-6 mb-8">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-900">Historial General de Órdenes de Servicio</h1>
                <button id="export-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Exportar a CSV
                </button>
            </div>
        </header>

        <main class="bg-white rounded-lg shadow p-6">
            <div class="table-container">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Orden</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teléfono</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dirección</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">RFC</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vehículo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Placas</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Año</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kilometraje</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nivel Gas</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Items</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subtotal</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IVA</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Observaciones</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Las filas se generarán dinámicamente con JavaScript -->
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBcwD2vzPRS174uH91pPkrUdd8j9Kj23wY",
            authDomain: "gestor-de-ordenes-1ba71.firebaseapp.com",
            projectId: "gestor-de-ordenes-1ba71",
            storageBucket: "gestor-de-ordenes-1ba71.appspot.com",
            messagingSenderId: "286628679845",
            appId: "1:286628679845:web:5f6b7ece092b298b1c3d4c"
        };
        const appId = firebaseConfig.projectId;
        const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
        const db = getFirestore(app);
        const auth = getAuth(app);

        let orders = [];
        let userId = null;

        // Verificar autenticación
        onAuthStateChanged(auth, user => {
            if (user) {
                userId = user.uid;
                loadOrders();
            } else {
                // Redirigir a login si no está autenticado
                window.location.href = 'login.html';
            }
        });

        function formatCurrency(value) {
            const number = parseFloat(value);
            if (isNaN(number)) {
                return value; // Devuelve el valor original si no es un número
            }
            return '$ ' + number.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function loadOrders() {
            const q = query(collection(db, `artifacts/${appId}/users/${userId}/orders`), orderBy("createdAt", "desc"));
            onSnapshot(q, snapshot => {
                orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderOrdersTable();
            }, error => {
                console.error("Error al obtener órdenes: ", error);
                alert("Error al cargar las órdenes. Por favor, intente nuevamente.");
            });
        }

        function renderOrdersTable() {
            const tbody = document.getElementById('orders-table-body');
            tbody.innerHTML = '';

            orders.forEach(order => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                // Formatear fecha
                const creationDate = order.createdAt 
                    ? order.createdAt.toDate().toLocaleDateString('es-ES') 
                    : 'N/A';

                // Formatear items
                const itemsText = order.items.map(item => 
                    `${item.qty}x ${item.description} (${formatCurrency(item.price)})`
                ).join('<br>');

                // Crear celdas
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${order.numericId}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${creationDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.status}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.client.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.client.cel || ''}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${order.client.address || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.client.rfc || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.client.email || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.vehicle.brand}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.vehicle.plates || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.vehicle.year || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.vehicle.km || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.vehicle.gasLevel || ''}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${itemsText}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(order.subtotal)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.iva ? formatCurrency(order.iva) : '$ 0.00'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${formatCurrency(order.total)}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${order.observations || ''}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Función para exportar a CSV
        function exportToCSV() {
            if (orders.length === 0) {
                alert('No hay órdenes para exportar');
                return;
            }

            // Crear encabezados del CSV
            const headers = [
                'ID Orden',
                'Fecha Creación',
                'Estado',
                'Cliente Nombre',
                'Cliente Teléfono',
                'Cliente Dirección',
                'Cliente RFC',
                'Cliente Email',
                'Vehículo Marca/Modelo',
                'Vehículo Placas',
                'Vehículo Año',
                'Vehículo Kilometraje',
                'Vehículo Nivel Gasolina',
                'Items',
                'Subtotal',
                'IVA',
                'Total',
                'Observaciones'
            ];

            // Crear filas del CSV
            const csvRows = [];
            csvRows.push(headers.join(','));

            orders.forEach(order => {
                // Formatear fecha
                const creationDate = order.createdAt 
                    ? order.createdAt.toDate().toLocaleDateString('es-ES') 
                    : 'N/A';
                
                // Formatear items
                const itemsText = order.items.map(item => 
                    `${item.qty}x ${item.description} (${formatCurrency(item.price)})`
                ).join(' | ');

                // Crear fila de la orden
                const row = [
                    order.numericId,
                    `"${creationDate}"`, 
                    `"${order.status}"`, 
                    `"${order.client.name}"`, 
                    `"${order.client.cel || ''}"`, 
                    `"${order.client.address || ''}"`, 
                    `"${order.client.rfc || ''}"`, 
                    `"${order.client.email || ''}"`, 
                    `"${order.vehicle.brand}"`, 
                    `"${order.vehicle.plates || ''}"`, 
                    order.vehicle.year || '',
                    order.vehicle.km || '',
                    `"${order.vehicle.gasLevel || ''}"`, 
                    `"${itemsText}"`, 
                    order.subtotal,
                    order.iva ? order.iva : '0.00',
                    order.total,
                    `"${order.observations || ''}"`
                ];
                
                csvRows.push(row.join(','));
            });

            // Crear blob y descargar
            const csvString = csvRows.join('\n');
            const blob = new Blob(['\ufeff' + csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `historial_completo_ordenes_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Agregar evento al botón de exportación
        document.getElementById('export-btn').addEventListener('click', exportToCSV);
    </script>
</body>
</html>